#order 1000
#material
#vertex use default
#fragment
#include "../lib/CameraData_Def.hmat"
#include "../lib/Basic_FS_Lib.hmat"

struct ScreenHitData
{
	uint2 hitPosition;
	uint hitDepth;
	uint hitInstanceID;
};

RWStructuredBuffer<ScreenHitData> hitData : register(u0);

[earlydepthstencil]
void DEFAULT_FS_MAIN
{
    float ndcZ = fin.svPos.z / fin.svPos.w;
    uint2 screenPos = trunc(fin.svPos.xy);
    if (ndcZ > 0 && all(hitData[0].hitPosition == screenPos)) {
        uint depth = 0xffffffff * ndcZ;
        uint oldDepth;
        InterlockedMax(hitData[0].hitDepth, depth, oldDepth);
        if (oldDepth != hitData[0].hitDepth)
            hitData[0].hitInstanceID = fin.InstanceID;
    }
}